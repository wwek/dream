<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRM Panel Test</title>
    <link rel="stylesheet" href="drm_panel.css">
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .test-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.clear {
            background: #f44336;
        }
        button.clear:hover {
            background: #da190b;
        }
        .data-display {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        h2 {
            color: #2196F3;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ§ª DRM Panel Test Page</h1>

        <div class="test-controls">
            <h2>Test Controls</h2>
            <button onclick="loadTestData()">Test Data 1 (Complete)</button>
            <button onclick="loadTestDataWithText()">Test Data 2 (with Text)</button>
            <button onclick="loadNoSignalData()">Simulate No Signal</button>
            <button onclick="loadErrorData()">Simulate Error State</button>
            <button class="clear" onclick="clearPanel()">Clear Panel</button>
        </div>

        <h2>DRM Status Panel</h2>
        <div id="openwebrx-panel-metadata-drm" class="openwebrx-panel openwebrx-meta-panel">
            <!-- DrmPanel will be rendered here -->
        </div>

        <h2>Received Data</h2>
        <div class="data-display" id="data-display">Waiting for data...</div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Simulate MetaPanel base class
        function MetaPanel(el) {
            this.el = el;
        }
        MetaPanel.prototype = {};

        // Load DrmPanel class
        var scriptLoaded = false;
        $.getScript('DrmPanel.class.js').done(function() {
            scriptLoaded = true;
            console.log('[Test] DrmPanel class loaded');
            initPanel();
        }).fail(function(jqxhr, settings, exception) {
            console.error('[Test] Failed to load DrmPanel:', exception);
        });

        var drmPanel = null;

        function initPanel() {
            if (!scriptLoaded || !window.DrmPanel) {
                console.error('[Test] DrmPanel not available');
                return;
            }
            var el = document.getElementById('openwebrx-panel-metadata-drm');
            drmPanel = new DrmPanel(el);
            console.log('[Test] DrmPanel initialized');
        }

        // Test Data 1: Complete data (including all new fields)
        var testData = {
            "timestamp": 1761640323,
            "received_time": 1736948400,  // DRM transmission time: 2025-01-15 14:30:00 UTC
            "status": {
                "io": 0,
                "time": 0,
                "frame": 0,
                "fac": 0,
                "sdc": 0,
                "msc": 0
            },
            "signal": {
                "if_level_db": -22.9,
                "snr_db": 14.0,
                "wmer_db": 13.8,
                "mer_db": 13.5,  // New: MER
                "doppler_hz": 0.6,
                "delay_min_ms": 3.9,
                "delay_max_ms": 6.56
            },
            "frequency": {  // New: Frequency parameters object
                "dc_offset_hz": 9998.43,
                "sample_offset_hz": 0.12,
                "sample_offset_ppm": 2
            },
            "mode": {
                "robustness": 1,
                "bandwidth": 3,
                "bandwidth_khz": 10.0,
                "interleaver": 0
            },
            "coding": {
                "sdc_qam": 0,
                "msc_qam": 1,
                "protection_a": 0,
                "protection_b": 0
            },
            "services": {
                "audio": 1,
                "data": 0
            },
            "service_list": [
                {
                    "id": "3E9",
                    "label": "CNR-1",
                    "is_audio": true,
                    "audio_coding": 3,
                    "bitrate_kbps": 11.64,
                    "audio_mode": "Mono",  // New: Audio mode
                    "protection_mode": "EEP",  // New: Protection mode
                    "language": {
                        "fac_id": 3,
                        "name": "Chinese (Mandarin)"
                    },
                    "program_type": {
                        "id": 1,
                        "name": "News"
                    }
                }
            ],
            "media": {
                "program_guide": false,
                "journaline": false,
                "slideshow": true
            },
            "media_content": {
                "slideshow": {
                    "timestamp": 1736948450,
                    "name": "test_slide.png",
                    "mime": "image/png",
                    "size": 85,
                    "data": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
                }
            }
        };

        // Test Data 2: With text and multiple services (UEP protection mode example)
        var testDataWithText = {
            "timestamp": 1761560992,
            "received_time": 1736950000,  // DRM transmission time: 2025-01-15 14:56:40 UTC
            "status": {
                "io": 0,
                "time": 0,
                "frame": 0,
                "fac": 0,
                "sdc": 0,
                "msc": 0
            },
            "signal": {
                "if_level_db": -29.6,
                "snr_db": 16.3,
                "wmer_db": 15.2,
                "mer_db": 14.8,
                "doppler_hz": 0.4,
                "delay_min_ms": 2.1,
                "delay_max_ms": 4.8
            },
            "frequency": {
                "dc_offset_hz": 10002.56,
                "sample_offset_hz": -0.08,
                "sample_offset_ppm": -1
            },
            "mode": {
                "robustness": 0,
                "bandwidth": 2,
                "bandwidth_khz": 9.0,
                "interleaver": 0
            },
            "coding": {
                "sdc_qam": 1,
                "msc_qam": 2,
                "protection_a": 1,
                "protection_b": 2
            },
            "services": {
                "audio": 1,
                "data": 1
            },
            "service_list": [
                {
                    "id": "111111",
                    "label": "DRM Service A",
                    "is_audio": true,
                    "audio_coding": 3,
                    "bitrate_kbps": 10.08,
                    "audio_mode": "Stereo",
                    "protection_mode": "UEP",
                    "protection_percent": 35.5,
                    "text": "\u4e0a\u6d77\u827a\u672f\u8282\u4e0a\u6f14\u7cbe\u5f69\u5267\u76ee\u3002\u8d5b\u3002"
                },
                {
                    "id": "222222",
                    "label": "DRM Service B",
                    "is_audio": false,
                    "bitrate_kbps": 9.6,
                    "protection_mode": "EEP"
                }
            ],
            "media": {
                "program_guide": false,
                "journaline": true,
                "slideshow": true
            },
            "media_content": {
                "journaline": {
                    "timestamp": 1736950000,
                    "available": true
                },
                "slideshow": {
                    "timestamp": 1736950050,
                    "name": "test_slide_2.png",
                    "mime": "image/png",
                    "size": 5678,
                    "data": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8DwHwAFBQIAX8jx0gAAAABJRU5ErkJggg=="
                }
            }
        };

        // No signal data
        var noSignalData = {
            "timestamp": Date.now(),
            "received_time": 0,  // Time unavailable
            "status": {
                "io": 0,
                "time": -1,
                "frame": -1,
                "fac": -1,
                "sdc": -1,
                "msc": -1
            },
            "signal": {
                "if_level_db": -65.0,
                "snr_db": 0.0
            },
            "frequency": {
                "dc_offset_hz": 0.0,
                "sample_offset_hz": 0.0,
                "sample_offset_ppm": 0
            },
            "media": {
                "program_guide": false,
                "journaline": false,
                "slideshow": false
            }
        };

        // Error state data
        var errorData = {
            "timestamp": Date.now(),
            "received_time": 1736948800,
            "status": {
                "io": 0,
                "time": 0,
                "frame": 0,
                "fac": 2,
                "sdc": 3,
                "msc": 5
            },
            "signal": {
                "if_level_db": -45.0,
                "snr_db": 1.2,
                "wmer_db": 3.5,
                "mer_db": 2.8
            },
            "mode": {
                "robustness": 1,
                "bandwidth": 4,
                "bandwidth_khz": 18,
                "interleaver": 1
            },
            "media": {
                "program_guide": true,
                "journaline": false,
                "slideshow": false
            }
        };

        function loadTestData() {
            if (!drmPanel) {
                alert('DrmPanel not initialized, please refresh the page');
                return;
            }
            displayData(testData);
            drmPanel.update({
                type: 'drm_status',
                value: testData
            });
            console.log('[Test] Loaded test data 1 (complete)');
        }

        function loadTestDataWithText() {
            if (!drmPanel) {
                alert('DrmPanel not initialized, please refresh the page');
                return;
            }
            displayData(testDataWithText);
            drmPanel.update({
                type: 'drm_status',
                value: testDataWithText
            });
            console.log('[Test] Loaded test data 2 (with text)');
        }

        function loadNoSignalData() {
            if (!drmPanel) {
                alert('DrmPanel not initialized, please refresh the page');
                return;
            }
            displayData(noSignalData);
            drmPanel.update({
                type: 'drm_status',
                value: noSignalData
            });
            console.log('[Test] Loaded no-signal data');
        }

        function loadErrorData() {
            if (!drmPanel) {
                alert('DrmPanel not initialized, please refresh the page');
                return;
            }
            displayData(errorData);
            drmPanel.update({
                type: 'drm_status',
                value: errorData
            });
            console.log('[Test] Loaded error data');
        }

        // Test good signal (yellow)
        function loadGoodSignal() {
            if (!drmPanel) {
                alert('DrmPanel not initialized, please refresh the page');
                return;
            }
            var goodSignalData = JSON.parse(JSON.stringify(testData));
            goodSignalData.signal.snr_db = 12.5;
            goodSignalData.signal.wmer_db = 11.8;
            displayData(goodSignalData);
            drmPanel.update({
                type: 'drm_status',
                value: goodSignalData
            });
            console.log('[Test] Loaded good signal (yellow)');
        }

        // Test poor signal (red)
        function loadPoorSignal() {
            if (!drmPanel) {
                alert('DrmPanel not initialized, please refresh the page');
                return;
            }
            var poorSignalData = JSON.parse(JSON.stringify(testData));
            poorSignalData.signal.snr_db = 8.2;
            poorSignalData.signal.wmer_db = 7.5;
            displayData(poorSignalData);
            drmPanel.update({
                type: 'drm_status',
                value: poorSignalData
            });
            console.log('[Test] Loaded poor signal (red)');
        }

        function clearPanel() {
            if (!drmPanel) {
                alert('DrmPanel not initialized, please refresh the page');
                return;
            }
            drmPanel.clear();
            displayData(null);
            console.log('[Test] Cleared panel');
        }

        function displayData(data) {
            var display = document.getElementById('data-display');
            if (data) {
                display.textContent = JSON.stringify(data, null, 2);
            } else {
                display.textContent = 'Panel cleared';
            }
        }
    </script>
</body>
</html>
